<?php

namespace app\modules\catalog\controllers;

use app\modules\catalog\models\entity\CompositionProducts;
use app\modules\catalog\models\entity\CompositionType;
use app\modules\catalog\models\entity\NotifyAdmission;
use app\modules\catalog\models\entity\Properties;
use app\modules\catalog\models\entity\PropertiesProductValues;
use app\modules\catalog\models\helpers\ProductHelper;
use app\modules\site\models\tools\Debug;
use Yii;
use yii\helpers\ArrayHelper;
use yii\helpers\Json;
use yii\web\Controller;
use app\modules\site\models\tools\System;
use app\modules\seo\models\tools\Attributes;
use app\modules\seo\models\tools\og\OpenGraph;
use app\modules\seo\models\tools\og\OpenGraphProduct;
use app\modules\catalog\models\entity\ProductCategory;
use app\modules\catalog\models\entity\Product;
use yii\web\Response;

class ProductController extends Controller
{
    public function beforeAction($action)
    {
        $this->enableCsrfValidation = false;
        return parent::beforeAction($action); // TODO: Change the autogenerated stub
    }

    public function actionView($id)
    {
        $product = Product::findBySlug($id);
        if (!$product instanceof Product) throw new \yii\web\NotFoundHttpException("Товар не найден.");

        $category = ProductCategory::findOne($product->category_id);

        if (!empty($product->seo_description)) {
            Attributes::metaDescription($product->seo_description);
        } else {
            if (!empty($product->description)) {
                Attributes::metaDescription($product->description);
            } else {
                Attributes::metaDescription(sprintf('В нашем интернет-магазине зоотоваров в продаже  имеется %s по низкой цене в Барнауле. За каждую покупку выполучите 5%% бонусов, а мы доставим бесплатно!', $product->name));
            }
        }

        if (!empty($product->seo_keywords)) {
            Attributes::metaKeywords($product->seo_keywords);
        } else {
            Attributes::metaKeywords(explode(';', sprintf("купить %s в барнауле;интернет-зоомагазин;зоомагазин интернет барнаул;анго зоомагазин интернет барнаул;интернет зоомагазин с доставкой", $product->name)));
        }

        Attributes::canonical(System::protocol() . "://" . System::domain() . "/product/" . $product->slug . "/");

        OpenGraphProduct::title($product->name);
        if (!empty($product->description)) {
            OpenGraph::description($product->description);
            Attributes::metaDescription($product->description);
        }
        OpenGraphProduct::type();
        OpenGraphProduct::url(System::protocol() . "://" . System::domain() . "/" . Yii::$app->controller->action->id . "/" . $product->slug . "/");
        OpenGraphProduct::amount($product->price);
        OpenGraphProduct::currency('RUB');

        if ($product->media) OpenGraphProduct::image(ProductHelper::getImageUrl($product, true));

        $propertiesValues = PropertiesProductValues::find()
            ->where(['product_id' => $product->id])
            ->andWhere(['not in', 'property_id', ArrayHelper::getColumn(Properties::find()->select('id')->where(['is_show_site' => false])->all(), 'id')])
            ->all();
        ProductHelper::addVisitedItem($product->id);

        $compositionGroup = [];
        $compositions = CompositionProducts::find()->where(['product_id' => $product->id])->all();
        foreach ($compositions as $composit_value_item) {
            $compositionGroup[$composit_value_item->composition->composition_type_id]['group'] = CompositionType::findOne($composit_value_item->composition->composition_type_id);
            $compositionGroup[$composit_value_item->composition->composition_type_id]['items'][] = $composit_value_item;
        }

        return $this->render('view', [
            'product' => $product,
            'category' => $category,
            'compositionGroup' => $compositionGroup,
            'propertiesValues' => $propertiesValues,
        ]);
    }


    public function actionSaveNotifyAdmission()
    {
        Yii::$app->response->format = Response::FORMAT_JSON;
        $model = new NotifyAdmission();

        if ($model->load(Yii::$app->request->post())) {
            if ($model->validate() && $model->save()) {
                return Json::encode([
                    'success' => 1,
                ]);
            } else {
                return Json::encode([
                    'false' => 1,
                    'message' => $model->getErrors()
                ]);
            }
        }
    }


    public function actionRemoveNotifyAdmission()
    {
        Yii::$app->response->format = Response::FORMAT_JSON;
        $data = Yii::$app->request->post();

        if (NotifyAdmission::findOne(['email' => $data['email'], 'product_id' => $data['product_id']])->delete()) return Json::encode([
            'success' => 1,
        ]);
    }
}